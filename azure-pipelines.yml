trigger:
- main

pool:
  name: default

jobs:
- job: run_dast_scan
  displayName: Run DAST Scan
  steps:
  - task: Docker@2
    inputs:
      command: login
      containerRegistry: 'dockerhub' 
      azureSubscriptionEndpoint: 'MyDockerServiceConnection'

  - task: Bash@3
    displayName: 'Run OWASP ZAP Scan'
    inputs:
      targetType: 'inline'
      script: |
        mkdir -p owaspzap
        docker run --rm -v $(pwd)/owaspzap:/zap/wrk/:rw ghcr.io/zaproxy/zaproxy:stable zap-baseline.py -t http://172.213.198.195 -J zap_report.json -r zap_report.html
        docker run --rm -v $(pwd)/owaspzap:/zap/wrk/:rw ghcr.io/zaproxy/zaproxy:stable zap-baseline.py -t http://172.213.198.195 -o zap_report.txt

  - task: Bash@3
    displayName: 'Ensure report files exist'
    inputs:
      targetType: 'inline'
      script: |
        mkdir -p owaspzap
        if [ ! -f owaspzap/zap_report.json ]; then
          touch owaspzap/zap_report.json
        fi
        if [ ! -f owaspzap/zap_report.html ]; then
          touch owaspzap/zap_report.html
        fi
        if [ ! -f owaspzap/zap_report.txt ]; then
          touch owaspzap/zap_report.txt
        fi

  - task: CopyFiles@2
    condition: succeededOrFailed()
    inputs:
      SourceFolder: 'owaspzap/'
      TargetFolder: '$(Pipeline.Workspace)'

  - task: PublishPipelineArtifact@1
    condition: succeededOrFailed()
    inputs:
      targetPath: '$(Pipeline.Workspace)/zap_report.json'
      artifact: 'owasp_zap_report_json'
      publishLocation: 'pipeline'
    displayName: 'Publish ZAP JSON Report'

  - task: PublishPipelineArtifact@1
    condition: succeededOrFailed()
    inputs:
      targetPath: '$(Pipeline.Workspace)/zap_report.html'
      artifact: 'owasp_zap_report_html'
      publishLocation: 'pipeline'
    displayName: 'Publish ZAP HTML Report'

  - task: PublishPipelineArtifact@1
    condition: succeededOrFailed()
    inputs:
      targetPath: '$(Pipeline.Workspace)/zap_report.txt'
      artifact: 'owasp_zap_report_txt'
      publishLocation: 'pipeline'
    displayName: 'Publish ZAP TXT Report'
